Main 
Cancer immunotherapies by immune checkpoint blockade (ICB) aim to help the immune system recognize and attack cancer cells1 . The primary targets of ICB treatment are programmed death-ligand 1 (PD-L1), programmed death 1 (PD1) and cytotoxic T-lymphocyte-associated protein 4 (CTLA4). Compared to conventional therapies, ICB can induce durable responses in patients with metastatic cancers. However, a significant limitation of ICB is that only one-third of patients respond to ICB in most cancer types tested 2 . Combination ICB therapies have shown improved outcomes but also result in more severe side effects than single-agent therapy1 . Multiple factors can affect ICB effectiveness2 , including the degree of cytotoxic T cell infiltration3 , mutation or neo-antigen load4 , PD-L1 level5 , antigen presentation defects6 , interferon signaling7 , mismatch repair deficiency8 , tumor aneuploidy9 and intestinal microbiota10 . However, none of these factors is sufficient to achieve accurate outcome prediction5 , and identification of ICB response biomarkers and resistance regulators is a critical challenge in the field. 
Gene expression biomarkers, such as Oncotype DX11 , MammaPrint12 and Prosigna13 , have demonstrated clinical utility in predicting treatment benefits in breast cancer. We hypothesize that transcriptome signatures could also serve as reliable ICB biomarkers. Ideally, a large number of tumor molecular profiles together with the patient clinical outcome could be used to train a reliable multi-gene biomarker. However, current ICB clinical trials have gene expression profiles on only a small number of pre-treatment samples, which are insufficient to train robust prognostic biomarkers3,14,15 . Alternatively, there are many public tumor profiling data sets from human and mouse models without immunotherapy, but which are informative regarding tumor immune escape. For example, recent analyses of TCGA and PRECOG data uncovered significant effects of tumor-infiltrating levels of different immune cell types on patient overall survival16-18 . Predicting tumor response to ICB requires an understanding of how tumors escape the immune system. Therefore, the public tumor molecular profiles, even without ICB treatment, may still be valuable resources to model immune evasion and derive surrogate biomarkers of ICB response. 
Recent work has revealed two distinct mechanisms of tumor immune evasion19,20 . Some tumors have a high level of infiltration by cytotoxic T cells, but these T cells tend to be in a dysfunctional state. In other tumors, immunosuppressive factors may exclude T cells from infiltrating tumors 21 . Therefore, we developed a computational framework, Tumor Immune Dysfunction and Exclusion (TIDE), to identify factors that underlie these two mechanisms of tumor immune escape. TIDE integrated and modeled data from 189 human cancer studies, comprising a total of 33,197 samples. We hypothesized and validated that an accurate gene signature to model the tumor immune escape could serve as a reliable surrogate biomarker to predict ICB response. The web application, source code and analysis results of TIDE are available at http://tide.dfci.harvard.edu .
Results 
A statistical interaction test identifies gene signatures of T cell dysfunction 
Previous reports showed that cytotoxic T cells could infiltrate a subset of tumors, although they could still fail to control tumor growth if in a dysfunctional state22 . We reasoned that by combining transcriptome profiles of treatment-naive tumors with patient survival outcome, we could identify known regulators of T cell dysfunction. For example, in the TCGA melanoma study, we used the average expression level of CD8A , CD8B , GZMA , GZMB and PRF1 to estimate the cytotoxic T lymphocyte (CTL) level in a tumor16 . Among metastatic melanoma tumors, a higher CTL level indicates a better patient survival, but only when TGFB1 has a low expression level (Fig. 1a and Supplementary Fig. 1a). This observation corroborates the known role of the cytokine TGF[beta] (encoded by TGFB1 ) in promoting tumor immune escape and immunotherapy resistance 2,23,24 . 
In statistics, two variables interact if the effect of one variable depends on the other variable25 . In the previous examples, the effect of CTL on survival outcome depends on the TGFB1 level, which is a typical case of interaction between variables. The interaction of any two variables on survival outcome can be tested by a multiplication term in the Cox proportional hazard (Cox-PH) model26 (Fig. 1b). The coefficient d of the multiplication term indicates the level of the interaction effect, and the Wald test can evaluate its statistical significance26 . For example, the TGFB1 expression level has a significantly antagonistic interaction with CTL level, indicating that a higher TGFB1 level in tumors will decrease the beneficial association between CTL and overall survival (Supplementary Table 1a). In contrast to TGFB1 , another gene SOX10 expression level has a synergistic interaction with CTL level on patient survival outcome, indicating that a higher SOX10 level in tumors will increase the beneficial association between CTL and survival (Supplementary Table 1b), which is consistent with the known function of SOX10 to promote T cell-mediated tumor killing27,28 . 
We aim to systematically identify genes such as TGFB1 and SOX10 that influence the function of cytotoxic T cells on patient survival outcome in cancer genomics data cohorts. Using the Cox-PH model, TIDE tests how the interaction between a candidate gene V and the CTL affects death hazard (estimated from survival) (Fig. 1b). The resulting T cell dysfunctional signature is a genome-wide vector, where the z score of each gene is the interaction coefficient d divided by its standard error (Supplementary Table 1). Genes with significant z scores are not restricted to genes expressed by T cells but could be expressed in cancer cells (for example, SOX10 27,28 ) or different immune cells associated with T cell dysfunction. In the case of TGFB1 , both cancer cells29 and CD4+ FOXP3+ Treg cells30 can express the cytokine TGF[beta] to inhibit T cell function. 
To compute the T cell dysfunction scores in different cancer data sets, we collected hundreds of data sets from the TCGA31 , PRECOG17 and METABRIC32 databases, and focused on 73 that had a minimum of 50 samples with both tumor expression profiles on the genome scale and patient survival data (Supplementary Table 2a). Among the data sets, TIDE predicted different numbers of genes to interact with CTL with statistical significance. For example, the P -value distribution for genes in TCGA melanoma was skewed to the left, indicating many significant genes (Supplementary Fig. 1b). However, the peak of significant P values was absent in TCGA glioblastoma. This difference is likely due to differences in T cell infiltration, data quality or sample size. In five data sets, over 1% of genes have significant interaction with CTL to affect survival at a false discovery rate (FDR) cutoff of 0.1: melanoma, neuroblastoma, triple-negative breast cancer, endometrial cancer and acute myeloid leukemia (Supplementary Fig. 1b and Supplementary Table 2b). For visualization, genes with significant dysfunction scores (FDR < 0.1) in at least two cancer types are shown in Fig. 1c (Supplementary Table 3). Although some of the genes are known to regulate T cell-mediated tumor immunity, such as PD-L1 , others are likely to be co-expressed with immune-suppressive genes. 
The TIDE dysfunction scores are consistent with signatures of tumor immune evasion 
We evaluated the quality of TIDE T cell dysfunction scores using published studies of tumor immune evasion in pre-clinical models (Supplementary Table 4). One shRNA screen identified positive or negative hit genes whose knockdown in T cells enhanced or decreased T cell accumulation in mouse tumors, respectively33 . Gene expression profiles to study T cell dysfunction are also publicly available, including the transcriptome of exhausted CD8 T cells34 , activated regulatory T cells35 and tumors with acquired ICB resistance36 . The positive or negative hits are defined as genes upregulated or downregulated in the process of T cell dysfunction or ICB resistance, respectively (Supplementary Tables 4 and 5). We examined whether the TIDE T cell dysfunctional signatures give significantly different scores between positive and negative hit genes in these published studies. We found that TIDE dysfunction signatures averaged from the five clinical cohorts assign positive hits significantly higher dysfunction scores compared to the negative hits (Fig. 2a). Using receiver operating characteristic (ROC) curves, we found that averaging the TIDE dysfunction signatures from the five cohorts gave the best performance (Fig. 2b,c and Supplementary Fig. 2a), suggesting the average profile as a more robust dysfunctional signature. 
Recent studies in mouse tumor models revealed two stages of T cell dysfunction37,38 . While anti-PD1 treatment can revive the early-stage dysfunctional T cells, late-stage dysfunctional T cells are resistant to ICB reprogramming. The average profile of TIDE dysfunction signatures derived from the five cancer cohorts shows increasing correlation with the gene expression profiles of dysfunctional T cells in late stages38 (Fig. 2d). This result suggests that the TIDE dysfunction signatures reflect the profiles at the late stage of T cell dysfunction. We also applied gene set enrichment analysis to analyze the functional enrichment of TIDE T cell dysfunction signatures. Immune pathways related to inflammatory and interferon response are highly enriched, while mTORC1 signaling39 , protein secretion40 and glycolysis41 that are known to promote CD8 T cell activation are consistently depleted (Supplementary Fig. 2b). 
Immunosuppressive cell signatures predict immune escape by T cell exclusion 
The previous section described T cell dysfunction signatures in tumors with high cytotoxic T cell infiltration. Next, we explored gene signatures of immune evasion through T cell exclusion in tumors with low T cell infiltration19,20 . Several molecular mechanisms might explain the lack of T cell infiltration in the tumor, such as impaired priming of tumor-specific T cells or suppressive cells prohibiting T cell infiltration into the tumor 19,20 . To model the gene expression signature of T cell exclusion, we examined three cell types reported to restrict T cell infiltration in tumors, namely cancer-associated fibroblasts (CAFs), myeloid-derived suppressor cells (MDSCs) and the M2 subtype of tumor-associated macrophages (TAMs)20 . We derived a genome-wide signature of T cell exclusion using expression profiles of these cell types from the Gene Expression Omnibus database 42 (Supplementary Table 4). In TCGA melanoma data, tumors whose expression profiles have a higher correlation with the MDSC, TAM or CAF signatures show a significantly lower level of CTLs (Fig. 3a). Moreover, using the average expression profile of MDSCs, TAMs and CAFs to model T cell exclusion, we observed a strong negative correlation between the T cell exclusion scores and the CTL levels across tumors (Fig. 3a). Moreover, the CTL levels and T cell exclusion scores were negatively correlated in all solid tumor data sets (Fig. 3b). 
We further examined the associations between the gene signatures of T cell exclusion and T cell dysfunction. For each tumor, the enrichment of a signature is computed as the Pearson correlation between the tumor gene expression profile and the genome-wide scores of T cell exclusion or dysfunction signatures. In the five cancer types where we can identify significant T cell dysfunction scores, the level of T cell exclusion in a tumor inversely correlates with the level of T cell dysfunction (Fig. 3c and Supplementary Fig. 3a). We also calculated the signature enrichment based on the differential expression between tumor and normal samples across TCGA cancer types and observed similar negative correlations between T cell exclusion and T cell dysfunction (Fig. 3d and Supplementary Table 6). Kidney renal cell carcinoma (KIRC) has the highest CTL level and the highest enrichment of the T cell dysfunction signature (Fig. 3d and Supplementary Fig. 3b), while lung squamous carcinoma (LUSC) has the highest T cell exclusion signature (Fig. 3d and Supplementary Fig. 3c). Our results are consistent with previous reports of a high CTL level in KIRC and a low CTL level in LUSC16 . These results suggest that the KIRC and LUSC tumors utilize distinct immune evasion strategies, with KIRC operating more through T cell dysfunction and LUSC through T cell exclusion. Previous studies reported paradoxical observations that in KIRC the degree of CD8 cytotoxic T cell infiltration is anti-correlated with survival benefits43 . Our analysis revealed that KIRC tumors with higher CTL levels tend to have a stronger T cell dysfunction signature, which could impair the ability of cytotoxic T cells to kill cancer cells (Supplementary Fig. 3b). 
TIDE signature predicts ICB response 
In previous sections, we developed genome-wide expression signatures to measure the level of T cell dysfunction and T cell exclusion in tumors. We next examined whether integrating these two signatures could predict ICB clinical response. Among the five cancer types for which we could compute reliable TIDE signatures (Fig. 1c), only melanoma has publicly available data on tumor expression and clinical outcome of patients treated with anti-PD1 14 or anti-CTLA43 , so it was the focus of our evaluation. We also evaluated TIDE on an anti-PD1 data set that profiled tumor expression profiles across four cancer types using the NanoString assay on a few hundred genes15 . 
We classified the tumors as CTL-high if the expression levels of all CTL markers (CD8A , CD8B , GZMA , GZMB and PRF1 ) were higher than their average values in each data set and the remaining tumors as CTL low. In the CTL-high tumors, TIDE correlates the tumor expression data with the T cell dysfunction signature and predicts tumors with high correlation to T cell dysfunction as non-responders (Supplementary Fig. 4a). In CTL-low tumors, it has been reported that ICB can enhance the cytotoxic T cell infiltration44,45 , so patients with low tumor CTL might still derive clinical benefits from immunotherapies. Therefore, TIDE correlates the expression data for each tumor with the T cell exclusion signature in CTL-low tumors and predicts those with suppressive cells inhibiting T cell infiltration as non-responders (Supplementary Fig. 4a). Notably, the correlation between tumor expression profiles and TIDE signatures is a single value computed across all human genes (Supplementary Fig. 4b), and therefore not subject to multiple-hypotheses testing and less sensitive to the noise from individual expression or the TIDE signature value. For the pre-treatment transcriptome of each tumor, the Pearson correlation with either T cell dysfunction (in CTL-high tumors) or exclusion (in CTL-low tumors) signatures was defined as the TIDE prediction score (Fig. 4a-c). Correlations with T cell dysfunction or exclusion signatures may have different distributions (Supplementary Fig. 4c). Thus, when merging the prediction scores from two tumor CTL categories, we normalized the correlations by their standard deviations in the TCGA data. Finally, all tumors were ranked by their TIDE scores to predict their ICB response (Fig. 4a-c and Supplementary Fig. 4d). 
To evaluate the prediction performance for ICB response, we used ROC to measure the true-positive rates against the false-positive rates at various thresholds of TIDE prediction scores (Fig. 4d-f). Compared to widely used ICB response biomarkers, tumor mutation load, PD-L1 level and interferon gamma response5,7 , the TIDE signature achieved consistently better performance for both anti-PD1 and anti-CTLA4 therapies using both RNA-Seq and NanoString data (Fig. 4d-f and Supplementary Fig. 5a). We also compared TIDE with other ICB response signatures reported in the literature (Supplementary Table 7). Among all candidate biomarkers, we found the TIDE signature to be the best predictor for both anti-PD1 and anti-CTLA4 therapies (Fig. 4g-i and Supplementary Table 8a). The prediction performance of TIDE is also higher than the signatures of T cell dysfunction and ICB resistance discussed in Fig. 2a (Supplementary Fig. 5b). Meanwhile, the TIDE prediction performance is robust against modest variations of CTL cutoff in the definition of CTL-high or -low tumors (Supplementary Fig. 5c). Moreover, a higher tumor TIDE prediction score is associated not only with worse ICB response, but also with worse patient survival under anti-PD1 and anti-CTLA4 therapies (Fig. 4j-l). One explanation for the better performance of TIDE is that TIDE utilized both T cell dysfunction and exclusion signatures to model immune escape in tumors with different CTL levels, while other biomarkers consider only one aspect (Supplementary Fig. 5d-f and Supplementary Table 8b,c). Paradoxically, a previous computational method ImmunoPhenoScore claimed to have 100% accuracy in predicting ICB response in melanoma46 , but we observed considerably lower accuracy of ImmunoPhenoScore using the source codes provided by the authors (Fig. 4g-i). 
Besides the anti-PD1 RNA-Seq cohort14 analyzed in Fig. 4, a recent study generated RNA-Seq profiles on another melanoma cohort treated with anti-PD145 . We focused on 24 patients with genomics profiles (expression and mutation) of pre-treatment tumors and anti-PD1 as the first-line immunotherapy (without previous anti-CTLA4 therapy). While the TIDE prediction score has a similar accuracy to the mutation load (Supplementary Fig. 6a,b), it is significantly predictive of the patient overall survival ('Ipi naive' in Supplementary Fig. 6c), demonstrating its prognostic value. We noted that TIDE achieved a lower prediction performance in the Riaz study compared to its performance in the Hugo study (Fig. 4d versus 'Ipi naive' in Supplementary Fig. 6). A possible explanation is that the Riaz study 45 used the RECIST v1.1 criteria for disease progression, while the Hugo study 14 used the immune-related RECIST47 , which is more appropriate for predicting immunotherapy response. Further, TIDE is trained using data from ICB-naive tumors and thus not relevant in modeling the tumors that progressed after a first-line ICB2 ('Ipi progressed' in Supplementary Fig. 6). 
The TIDE dysfunction score predicts regulators of ICB resistance 
We hypothesized that some genes with high scores in TIDE signatures might serve not only as biomarkers but also as ICB resistance regulators. We focused on the T cell dysfunction signature for genes regulating T cell dysfunction in tumors. As the T cell dysfunction scores were computed using the data from treatment-naive tumors, we utilized orthogonal data from a mouse model of acquired anti-CTLA4 resistance to identify genes that are associated with ICB resistance36 . We ranked genes with significant T cell dysfunction scores in Fig. 1c by the expression fold-change in the ICB-resistant tumors36 and identified Serpinb9 as the most upregulated gene (Fig. 5a,b). In ICB clinical cohorts, the SERPINB9 expression level is consistently lower in responders than non-responders (Supplementary Fig. 7a). Moreover, SERPINB9 expression alone is significantly associated with worse overall survival in two clinical studies of anti-CTLA4 therapy3,48 (Fig. 5c, Supplementary Fig. 7b and Supplementary Table 9). 
SERPINB9 is a member of the serine protease inhibitor (serpin) family. The encoded protein can inactivate granzyme B to protect lymphocytes (for example, T cells and natural killer cells) from granzyme that may leak from the granules 49 . It is normally expressed in cytotoxic lymphocytes, antigen-presenting cells and immune-privileged sites50-52 . Meanwhile, a study using in vitro cell culture models reported that a high SERPINB9 level in cancer cells resulted in resistance to T cell-mediated killing 53 . To infer which cell type in tumors is the potential source of a high SERPINB9 level, we examined the Protein Atlas database of immunohistochemistry results for 15,000 genes in 20 cancer types54 . The SERPINB9 protein is expressed at a higher level in cancer cells of melanoma and several other cancer types as compared to normal tissues (Supplementary Fig. 7c,d). Thus, SERPINB9 may promote the resistance to T cell-mediated killing during ICB therapy through its high expression in cancer cells. 
To validate SERPINB9 function in cancer cells, we knocked out Serpinb9 using CRISPR-Cas9 in the murine B16F10 melanoma cell line, which is the parental line of the anti-CTLA4-resistant tumor model previously discussed 36 . After knocking out Serpinb9 using two different CRISPR guide RNAs (gRNAs), the protein level became undetectable (Fig. 5d and Supplementary Fig. 8). When co-cultured with Pmel-1 cytotoxic T cells, the Serpinb9 -knockout B16F10 cells were more sensitive to T cell-mediated killing compared to control cells (Fig. 5e, Supplementary Fig. 9a and Supplementary Table 10). In contrast, B16F10 cells with Serpinb9 overexpression were significantly more resistant to T cell-mediated killing compared to control cells (Fig. 5f, Supplementary Fig. 9b and Supplementary Table 10). 
Notably, in B16F10 cells, the SERPINB9 protein level is significantly increased on treatment with IFN[gamma], a cytokine produced by cytotoxic T cells following antigen-specific activation55 (Fig. 5d). This SERPINB9 induction following IFN[gamma] treatment might be explained by the binding of IRF1, a transcription factor activated by IFN[gamma] signaling56 , near the Serpinb9 gene that is observed in public ChIP-Seq data sets (Supplementary Fig. 10a,b). In human melanoma tumors, the expression level of SERPINB9 is highly correlated with IRF1 on both bulk tumor and single-cell levels (Supplementary Fig. 10c,d). These results support that SERPINB9 in cancer cells regulates resistance to T cell-mediated killing, which is essential for ICB response. Interestingly, the SERPINB9 expression level is also consistently upregulated following pathogen infection in curated studies from the NCBI Gene Expression Omnibus 42 and Expression Atlas57 databases (Supplementary Fig. 11 and Supplementary Table 11). This result indicates that SERPINB9 is potentially a general regulator of immune evasion utilized by both tumors and pathogens. 
Discussion 
We developed a computational method called TIDE, which integrates the expression signatures of T cell dysfunction and T cell exclusion to model tumor immune evasion. The TIDE signatures, trained from treatment-naive tumor data, can predict ICB clinical response based on pre-treatment tumor profiles. Furthermore, TIDE predicted regulators of ICB resistance whose inhibition might improve ICB response. We experimentally validated the role of SERPINB9, an inhibitor of the cytotoxic lymphocyte protease GZMB, in tumor immune evasion, which is an essential process of ICB resistance. Although no small-molecule inhibitor of SERPINB9 is available, the Pfizer OASIS database indicates this protein as potentially druggable58 . 
Of the 73 data sets analyzed in this study, only five gave statistically significant T cell dysfunction signatures from the interaction test (Supplementary Table 2). This result is partly because we considered only 48 out of the 73 data sets where a higher level of tumor-infiltrating cytotoxic T cells is correlated with better survival outcome. In some cancer types, such as renal cell carcinoma, which has a substantial level of CD8 T cell infiltration, higher CTL may not be associated with survival benefits 43 . Also, depending on the sample size or characteristics of specific data sets, there might not be any statistically significant genes interacting with CTL to influence survival. Since averaging signatures from the five data sets yielded a signature more robust than any individual signature, integrating additional cancer data sets in the future has the potential to further improve the robustness of the T cell dysfunction scores (Fig. 2c). With additional data, cancer-type-specific regulators may be identified on the basis of the biological variations of T cell dysfunction scores across different cancer types. 
When using the TIDE model to predict ICB response, we determined a cutoff to classify tumors as CTL-high or CTL-low. We used the average expression of CTL markers (CD8A , CD8B , GZMA , GZMB and PRF1 ) across all tumors to determine the CTL threshold. However, if matched normal tissues are available, the CTL threshold could also be determined by comparing the CTL marker expression in tumors with marker expression in normal tissues. The TIDE signature consists of genome-wide scores of T cell dysfunction and exclusion. While a genome-wide transcriptome biomarker might be robust for ICB response prediction, RNA-Seq has not been widely adopted in the clinic. A smaller gene panel for qPCR or NanoString assays could be more clinically pragmatic. We demonstrated TIDE performance on an anti-PD1 response data set where baseline tumor expression was measured on the NanoString PanCancer panel (Fig. 4c). 
One limitation of our study is that we focused primarily on gene expression biomarkers. However, other biomarker types can also predict T cell infiltration and ICB response. For example, beta-catenin protein level has a negative correlation with CTL in many cancer types (Supplementary Fig. 3d,e and Supplementary Table 12). Moreover, tumors initially responding to ICB may later acquire mutations, such as in B2M , IFNGR1/2 and JAK1/2 genes, to become ICB resistant2 . However, our study focuses only on predicting intrinsic ICB resistance. Therefore, more data types and methods are necessary to model the immunotherapy efficacy comprehensively. It is possible that TIDE could be applied jointly with other types of biomarker to achieve a higher prediction performance. 
To enable testing of TIDE by clinicians and the public, we created a web application for response prediction using transcriptome profiles at http://tide.dfci.harvard.edu . TIDE has the potential to help oncologists select patients who are more likely to benefit from ICB. It would be of significant interest to test the clinical utility of TIDE in ICB decision-making in a prospective clinical trial. New immune-oncology data are emerging at an increasingly rapid pace. We envision that computational modeling and data integration will be increasingly utilized to refine ICB response biomarkers and identify new immunotherapy targets.
Methods 
Data collection of clinical genomics studies 
We collected cancer data sets with both patient survival durations and tumor gene expression profiles from the TCGA31 , PRECOG17 and METABRIC32 databases. If the clinical information is available, we separated the breast cancer data sets into the PAM50 (Prediction Analysis of Microarray 50, Prosigna) subtypes13 of luminal A, luminal B, Her2 positive, basal and triple negative (a variation of basal subtype). This separation is because each PAM50 subtype has a distinct genomics profile59 and degree of cytotoxic T cell infiltration60 . Among all TCGA cancers, melanoma has two major tumor types annotated (that is, primary and metastatic); thus, we split melanoma profiles into primary and metastatic subtypes. The PRECOG database provided only survival duration information without other clinical factors; thus, we cannot perform subtype analysis. METABRIC is a breast cancer cohort, and we split all tumors according to the PAM50 subtypes (luminal A, luminal B, HER2, basal and triple negative). 
To ensure the robustness of our analysis, we excluded the data sets from microarray platforms with fewer than 15,000 genes or without probes for cytotoxicity T cell markers (CD8A , CD8B , GZMA , GZMB and PRF1 ). Also, we included only data sets with more than 50 patients and 10% death rate because a low event number may undermine the reliability of Cox-PH survival regression26 . Finally, 73 data sets from 3 databases passed our selection criteria (Supplementary Table 2a). The expression values of all genes are normalized by subtracting the mean values across all samples in a data set. 
Statistical analysis 
The interaction test in multivariate Cox-PH regression was applied to identify gene association with T cell dysfunction phenotype. In statistics, two variables interact if the effect of one variable depends on the status of the other, and a multiplication term in a multivariate linear model can test the interaction effect between two variables25 . We applied the Cox-PH survival regression to test how the level of CTL interacts with other genes in the tumor to affect survival outcome. We solve a linear model Hazard = a ×CTL + b ×V + d ×CTL×V + c using the Cox-PH regression26 . The CTL level is estimated through the bulk-tumor expression average of CD8A , CD8B , GZMA , GZMB and PRF1 . In the Cox-PH model, the death hazard was estimated through the patient survival information. The variable V represents the expression level of a candidate gene in the test. Since we have selected data sets where CTL correlates with favorable survival outcome, the coefficient a is always negative. The association slope between CTL and Hazard is a + d ×V (Fig. 1b). If the coefficient d is positive, a higher V level will flatten the slope between CTL and Hazard, indicating a reduced association between the cytotoxic T cell level and better survival outcome. If d is negative, a higher V level will sharpen the slope between CTL and Hazard, indicating an increased association between the cytotoxic T cell level and better survival outcome. The T cell dysfunction score for each gene is defined as the Wald test z score, which is the coefficient d divided by its standard error26 (Fig. 1c and Supplementary Table 1). Of note, the thresholds shown in Fig. 1a and Supplementary Fig. 1a are used only to illustrate the principle of statistical interaction used by the model. When computing the T cell dysfunction scores through regression, we used the continuous variables without any thresholds. Also, we included clinical covariates, such as age, gender and stage (if available), in the regression to control for potential confounding factors. 
To identify significant genes in the interaction test, we applied the Benjamini-Hochberg method to convert the two-sided Wald test P values to FDRs61 , and selected clinical data sets with more than 1% genes having an FDR smaller than 0.1. This procedure is equal to selecting data sets where the distribution of P values has a significant peak near zero62 . For example, the P -value histogram computed using TCGA melanoma data has a spike near zero, indicating that a set of genes significantly interact with CTL to affect survival outcome (Supplementary Fig. 1b). In contrast, the result computed from glioblastoma data does not contain any genes with significant interactions (Supplementary Fig. 1b). 
Performance comparison on predicting ICB response 
We collected the RNA-Seq data in melanoma for anti-CTLA43 and anti-PD114 therapies with gene expression profiles for 25 and 42 pre-treatment tumors with complete clinical information, respectively. We collected the NanoString data for anti-PD1 therapies with gene expression profiles of 33 baseline tumors in four cancer types15 . For each data set, we standardized the transcriptome data across patients by quantile-normalization, and further normalized the expression values of each gene by subtracting the average among all samples. Therefore, a zero value indicates the average expression. 
To predict each tumor's potential to escape T cell-mediated killing, we first classified each tumor into CTL-high or CTL-low categories through the CTL marker expression levels (CD8A , CD8B , GZMA , GZMB and PRF1 ). Tumors with all positive values (higher than average) are classified as CTL-high, while the rest as CTL-low (Supplementary Fig. 4a). For the CTL-high tumors, we computed the Pearson correlation between tumor gene expression profiles and the T cell dysfunction signature (Supplementary Fig. 4b). For the CTL-low tumors, we computed the Pearson correlation between tumor gene expression profiles and the T cell exclusion signature (Supplementary Fig. 4b). The correlation with T cell dysfunction or exclusion signatures may have different distributions (Supplementary Fig. 4c). Therefore, to make the scale of Pearson correlations comparable between CTL-high and -low tumors, we normalized the correlation values within each sub-category through the standard deviation of correlations computed using the TCGA melanoma data. The scaled correlations were defined as TIDE prediction scores, representing the potential of tumor immune escape (Fig. 4a-c). 
We also computed the response prediction from other biomarkers published in the literature. The predicted values of gene expression biomarkers (for example, IFNG , CD8 , PDL1 and CRMA ) were the average values among all members defined by the original publications (Supplementary Table 7). The predicted values of ImmunoPhenoScore were computed using the source codes provided by the authors 46 . The predicted value of the tumor SCNA biomarker was downloaded from the original publication for the anti-CTLA4 data set9 and provided by W. Hugo for the anti-PD1 data set14 . 
The outcome predicted by all biomarkers is a range of values, instead of a binary outcome. For example, total mutation load, CD8 expression level and TIDE prediction score all give one value for each patient tumor instead of a response classification. Therefore, we utilized the ROC curve, which plots the true-positive rates versus false-positive rates at various thresholds of biomarker values (Fig. 4d-f). The area under the ROC curve was used as the quality metric of prediction (Fig. 4g-i). 
Gene selection for a focused TIDE signature 
We select the most informative genes with both high variance across tumors and significant values in the TIDE signature. We selected 770 genes because that number is compatible with a NanoString platform that could be designed for a clinical assay. In the first step, we computed the standard deviation of expression values across samples for all genes in each TCGA cancer data set and selected 4,150 genes whose standard deviation is higher than the average of all genes in more 80% TCGA data sets. Next, we ranked the 4,150 genes by their maximum absolute values in the TIDE signatures of T cell dysfunction and exclusion. From this ranked list, we selected the top 770 genes, which is the maximum number that can fit on a NanoString assay. The column 'TIDE.selected' in Fig. 4g-i shows the TIDE performance on selected genes. 
T cell killing assay based on co-culture between B16 and T cells 
B16F10 cells were maintained in complete DMEM media (10% FBS and 50 U ml -1 of penicillin/streptomycin). B16F10-Cas963 cells were maintained in complete DMEM media with 2.5-5 [micro]g ml -1 of blasticidin. CD8 T cells isolated from mice were cultured in complete RPMI 1640 media (10% FBS, 20 mM HEPES, 1 mM sodium pyruvate, 0.05 mM 2-mercaptoethanol, 2 mM l-glutamine and 50 U ml-1 streptomycin and penicillin). All cell lines are tested for mycoplasma contamination. Pmel-1 TCR transgenic mice were purchased from Jackson Laboratory (stock no. 005023). 
CD8 T cells were isolated from spleen and lymph nodes from Pmel-1 TCR transgenic mice using the EasySep mouse CD8+ T cell isolation kit (STEMCELL no. 19753) according to the manufacturer's protocol. Freshly isolated CD8 T cells were stimulated with anti-CD3/CD28 beads (ThermoFisher no. 11452D) at a bead to cell ratio of 1:2 to induce differentiation into an effector state. On day 3, recombinant mouse IL-2 (Biolegend, no. 575406) was added to the culture at 20 ng ml -1 . T cells were used for co-culture with B16F10 cells after at least six days of in vitro activation. Our animal experiments have complied with all relevant ethical regulations. The study protocol in this study was approved by the Institutional Care and Use Committee at Dana Farber Cancer Institute. 
To knockout Serpinb9 , CRISPR gRNA sequences targeting Serpinb9 or non-targeting control were cloned into a PLKO3G-GFP vector and confirmed by sequencing. To overexpress Serpinb9 , its cDNA was amplified, cloned into a pEF1a-puro vector and confirmed by sequencing. Knockout or overexpression constructs were co-transfected with pCMV-dR8.91 and pCMV-VSV-G (Addgene no. 8454) into HEK293T cells to generate lentivirus. Transfection was performed using TransIT-293 (Mirus, MIR2700) following the manufacturer's protocol. Lentivirus was collected 48 h later and stored at -80 °C. To generate Serpinb9 -knockout cells, B16F10-Cas9 cells were infected with a lentivirus driving expression of a single gRNA overnight to inactivate Serpinb9 genes individually. Infected cells were sorted on the basis of GFP expression by BD FACS Aria II. To generate Serpinb9 -overexpressing cells, B16F10-Cas9 cells were infected with either pEF1a-puro backbone or pEF1a-puro-Serpinb9 . Infected cells were selected by culturing with 2 [micro]g ml-1 puromycin. Control (non-targeting gRNA or pEF1a-puro backbone), Serpinb9- deficient or Serpinb9 -overexpressing B16F10-Cas9 cells were lysed and subjected to western blot analysis with the following antibodies: anti-SERPINB9 (Santa Cruz Biotechnology no. sc-57531) and anti-VCL (Sigma Aldrich no. V9264). 
In a competition assay with Serpinb9 -knockout cells, Serpinb9 -deficient or non-targeting guide control B16F10-Cas9 cells (GFP positive) were mixed with control B16F10-Cas9 cells (GFP negative) at a 1:1 ratio. In a competition assay with Serpinb9 -overexpressing cells, pEF1a control or pEF1a-Serpinb9 B16F10-Cas9 cells (GFP negative) were mixed with control GFP-infected B16F10-Cas9 cells (GFP positive) at a 1:1 ratio. Mixed cells were stimulated with 10 ng ml-1 or 100 ng ml-1 of interferon gamma for 24 h to enhance MHC class I expression. These tumor cells were then co-cultured with in vitro-activated Pmel-1 T cells at different effector-to-target ratios in a 6-well plate. Tumor cells were plated at equal density in all wells, and T cells were added at 0, 1/3, 1/2 or 100% of the number of tumor cells. There are two or three cell-culture replicates for each condition. After a three-day co-culture with T cells, the fold-change of Serpinb9 -edited B16F10 cells was determined by FACS, comparing the percentage of Serpinb9 -edited B16F10 cells to control B16F10 cells (Supplementary Fig. 9). T cells present in these cultures were gated out on the basis of antibodies specific for CD45 (APC-Cy7) (Biolegend, 103115). 

